import cv2
import numpy as np
import os

def compute_hdr_image(img_list, exposure_times):
    """
    Computes an HDR image and applies global tone mapping.
    
    Args:
        img_list (list): List of LDR images (NumPy arrays).
        exposure_times (np.array): Array of exposure times corresponding to each image in seconds.
    """
    
    print("Starting HDR processing...\n")
    
    # 1. Estimation of the Camera Response Function (CRF)
    print("1. Estimating Camera Response Function (CRF)...")
    try:
        calibrate = cv2.createCalibrateDebevec()
        response_function = calibrate.process(img_list, exposure_times)
        print("CRF estimated successfully.\n")
    except cv2.error as e:
        print(f"Error in CRF estimation: {e}")
        return
    
    # 2. Computation of the Irradiance Map (HDR image)
    print("2. Computing Irradiance Map (HDR image)...")
    merge_debevec = cv2.createMergeDebevec()
    hdr_image = merge_debevec.process(img_list, exposure_times, response_function)

    output_hdr_path = "output_hdr_image.hdr"
    cv2.imwrite(output_hdr_path, hdr_image)
    print(f"HDR image saved to: {output_hdr_path}\n")

    # 3. Global Tone Mapping Algorithm (Mantiuk)
    print("3. Applying Global Tone Mapping (Mantiuk)...")
    tone_map_mantiuk = cv2.createTonemapMantiuk(
        gamma=2.2,
        saturation=1.0,
        scale=0.7
    )

    # Slight improvement: No need for .copy()
    ldr_image = tone_map_mantiuk.process(hdr_image)

    # Convert float32 HDR â†’ uint8 LDR
    ldr_image_8bit = np.clip(ldr_image * 255, 0, 255).astype('uint8')

    output_ldr_path = "output_tone_mapped_image.jpg"
    cv2.imwrite(output_ldr_path, ldr_image_8bit)
    print(f"Tone-mapped LDR image saved to: {output_ldr_path}\n")

    # Display result only if windowing is available
    try:
        cv2.imshow("Tone Mapped Image", ldr_image_8bit)
        cv2.waitKey(0)
        cv2.destroyAllWindows()
    except cv2.error:
        print("Display not supported on this system (skipping window).")


## --- Example Usage --- ##

if __name__ == '__main__':
    image_paths = ["dark.jpg", "medium.jpg", "light.jpg"]
    
    img_list = []
    if all(os.path.exists(p) for p in image_paths):
        img_list = [cv2.imread(p) for p in image_paths]
    else:
        print("!! WARNING: Image files not found. Creating dummy images for demonstration. !!")
        dummy_img = np.zeros((100, 100, 3), dtype=np.uint8)
        img_list = [dummy_img, dummy_img, dummy_img]

    times = np.array([1/125.0, 1/30.0, 1/8.0], dtype=np.float32)

    if len(img_list) == len(times):
        compute_hdr_image(img_list, times)
    else:
        print("Error: The number of images does not match the number of exposure times.")
